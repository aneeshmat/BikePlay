<script>
  // ======== CONFIGURE YOUR ENDPOINT (ABSOLUTE URL) ========
  // Use your Flask server's IP/port here:
  const endpoint = "http://172.16.48.155:5000/navdata";

  let watchId = null;
  let lastSent = 0;
  const SEND_INTERVAL_MS = 1000;

  const statusEl = document.getElementById("status");
  const logEl = document.getElementById("log");
  const startBtn = document.getElementById("startBtn");
  const stopBtn = document.getElementById("stopBtn");

  function log(msg, cls = "") {
    const ts = new Date().toLocaleTimeString();
    const line = document.createElement("div");
    line.className = cls;
    line.textContent = `[${ts}] ${msg}`;
    logEl.prepend(line);
    if (cls === "error") console.error(msg); else console.log(msg);
  }

  async function sendData(payload) {
    try {
      const res = await fetch(endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
        keepalive: true
      });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const json = await res.json().catch(() => ({}));
      statusEl.textContent = "Data sent!";
      log(`POST ok → ${JSON.stringify(json)}`, "ok");
    } catch (err) {
      statusEl.textContent = "Error sending data.";
      log(`Send error: ${err.message}`, "error");
    }
  }

  function onPosition(position) {
    const now = Date.now();
    if (now - lastSent < SEND_INTERVAL_MS) return;
    lastSent = now;

    const c = position.coords;
    const payload = {
      latitude: c.latitude,
      longitude: c.longitude,
      speed: (c.speed ?? 0),
      heading: (c.heading ?? 0),
      accuracy: c.accuracy,
      altitude: c.altitude ?? null,
      altitudeAccuracy: c.altitudeAccuracy ?? null,
      timestamp: position.timestamp
    };

    log(`pos lat=${c.latitude.toFixed(6)} lon=${c.longitude.toFixed(6)} spd=${(payload.speed||0).toFixed(2)}m/s hdg=${payload.heading}`);
    sendData(payload);
  }

  function onGeoError(error) {
    statusEl.textContent = `Location error (${error.code}): ${error.message}`;
    log(`Geolocation error (${error.code}): ${error.message}`, "error");
  }

  function startTracking() {
    if (!navigator.geolocation) {
      statusEl.textContent = "Geolocation not supported.";
      log("navigator.geolocation missing", "error");
      return;
    }
    if (watchId !== null) return;

    statusEl.textContent = "Tracking started…";
    startBtn.disabled = true;
    stopBtn.disabled = false;

    watchId = navigator.geolocation.watchPosition(onPosition, onGeoError, {
      enableHighAccuracy: true,
      maximumAge: 0,
      timeout: 15000
    });
    log("watchPosition registered.");
  }

  function stopTracking() {
    if (watchId !== null) {
      navigator.geolocation.clearWatch(watchId);
      watchId = null;
      statusEl.textContent = "Tracking stopped.";
      log("Tracking stopped.", "ok");
    }
    startBtn.disabled = false;
    stopBtn.disabled = true;
  }

  startBtn.addEventListener("click", startTracking);
  stopBtn.addEventListener("click", stopTracking);
</script>